// @key @奶茶姐 压缩优化速度 可能？ 测试未压缩版在name_dev 说明： https://github.com/Keywos/rule
const $=$substore;const{isLoon:isLoon,isSurge:isSurge,isQX:isQX}=$substore.env;const target=isLoon?"Loon":isSurge?"Surge":isQX?"QX":undefined;const timeout=$arguments["timeout"]?$arguments["timeout"]:800;const flag=$arguments["flag"];const batch_size=$arguments["batch"]?$arguments["batch"]:20;async function operator(e){const t=new Date;console.log("初始节点数 = "+e.length);let n=0;while(n<e.length){const t=e.slice(n,n+batch_size);await Promise.allSettled(t.map((async e=>{try{const t=await queryDNSInfo(e.server);const n=await queryIpApi(e);e.name=flag?getFlagEmoji(n.countryCode)+" "+(t===n.query?"直连":"中转")+"→"+n.country:n.country;e.qc=t+"|"+n.query}catch(e){console.log(`err = ${e}`)}})));n+=batch_size}e=removeDuplicateName(e);console.log(`去重后个数 = ${e.length}`);e=removeqcName(e);const o=processProxies(e);const s=new Date;const c=s.getTime()-t.getTime();console.log(`方法总耗时 = ${c/1e3} 秒`);return e}async function queryDNSInfo(e){return new Promise(((t,n)=>{const o=`http://223.5.5.5/resolve?name=${e}`;$.http.get({url:o}).then((e=>{const o=JSON.parse(e.body);if(o.Status===0){const e=o.Answer[o.Answer.length-1].data;t(e)}else if(o.Status===3){const e=o.Question.name.slice(0, -1);t(e)}else{n(new Error(o.message))}})).catch((e=>{console.log("dns = "+e);n(e)}))}))}async function queryIpApi(e){return new Promise(((t,n)=>{const o=`http://ip-api.com/json?lang=zh-CN&fields=status,message,country,countryCode,city,query`;let s=ProxyUtils.produce([e],target);if(isLoon){s=s.substring(s.indexOf("=")+1)}const c={policy:s.substring(s.lastIndexOf("=")+1)};const r=new Promise(((e,t)=>{setTimeout((()=>{t(new Error("请求超时,丢弃节点"))}),timeout)}));const a=$.http.get({url:o,opts:c,node:s,"policy-descriptor":s}).then((e=>{const o=JSON.parse(e.body);if(o.status==="success"){t(o)}else{n(new Error(o.message))}})).catch((e=>{console.log("api = "+e);n(e)}));Promise.race([r,a]).catch((e=>{n(e)}))}))}function removeDuplicateName(e){const t=new Set;const n=[];for(const o of e){if(o.qc&&!t.has(o.qc)){t.add(o.qc);n.push(o)}}return n}function removeqcName(e){const t=new Set;const n=[];for(const o of e){if(!t.has(o.qc)){t.add(o.qc);const e={...o};delete e.qc;n.push(e)}}return n}function processProxies(e){const t=e.reduce(((e,t)=>{const n=e.find((e=>e.name===t.name));if(n){n.count++;n.items.push({...t,name:`${t.name} ${n.count.toString().padStart(2,"0")}`})}else{e.push({name:t.name,count:1,items:[{...t,name:`${t.name} 01`}]})}return e}),[]);const n=t.flatMap((e=>e.items));e.splice(0,e.length,...n);return e}function getFlagEmoji(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/🇹🇼/g,"🇨🇳")}